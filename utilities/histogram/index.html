<!DOCTYPE html>

<html lang="en">

<style type="text/css">
    html, body {
        background-image: url("terrain.jpeg");
        margin:10;
    }
    canvas {
        border: 2px solid black;
        width: 128px;
        height: 128px;
    }
</style>

<head>
    <meta charset="utf-8">

    <title>World War Paint</title>
    <meta name="description" content="worldwarpaint">
    <meta name="author" content="lukeandjosh">

</head>

<body>
    <!-- vertex shader -->
    <script src="/webgl-utils.js"></script>
<!--    <script src="https://rawgit.com/greggman/twgl.js/master/dist/twgl.min.js"></script>-->
    
    <script id="2d-vertex-shader" type="x-shader/x-vertex">
    attribute vec2 a_position; //varies between 0->buffer pixels size
    //attribute vec2 a_texCoord; //varies between 0->1

    uniform float u_flipY; //flip along y axis or not
    uniform vec2 u_resolution; //total dest resolution
    
    uniform vec2 u_buff_resolution; // buff resolution
    uniform vec2 u_buff_position; // buff position
    uniform bool u_vxDrawFromBuffer;

    varying vec2 v_texCoord; //varies between buffer start->buffer end

    void main() {
       // convert the rectangle from pixels to 0.0 to 1.0
       vec2 zeroToOne = a_position / u_resolution;

       // convert from 0->1 to 0->2
       vec2 zeroToTwo = zeroToOne * 2.0;

       // convert from 0->2 to -1->+1 (clipspace)
       vec2 clipSpace = zeroToTwo - 1.0;

       gl_Position = vec4(clipSpace * vec2(1, u_flipY), 0, 1);

       // pass the texCoord to the fragment shader
       // The GPU will interpolate this value between points.
       if(u_vxDrawFromBuffer){
           v_texCoord = zeroToOne;
           //v_texCoord = (u_buff_position + (a_texCoord * u_buff_resolution)) / u_resolution;
       }
       else{
           v_texCoord = zeroToOne;
           //v_texCoord = (u_buff_position + (a_texCoord * u_buff_resolution)) / u_resolution;
           //v_texCoord = a_texCoord;
       }
    }
    </script>
    <!-- fragment shader -->
    <script id="histogram-fragment-shader" type="x-shader/x-fragment">
        precision mediump float;

        // our 2 canvases
        uniform sampler2D u_textureIn;
        uniform bool u_initialInput;
        uniform vec2 u_resolutionIn;
        
        uniform vec3 playerClrs[4];

        // the texCoords passed in from the vertex shader.
        varying vec2 v_texCoord;

        void main() {
            vec4 colorOut = vec4(0,0,0,0);
            
            if(u_initialInput){
                for(int x=0; x<4; x++){
                    for(int y=0; y<4; y++){
                        vec2 currentPixel = vec2(x,y) / u_resolution;
                        vec4 colorIn = texture2D(u_textureIn, (v_texCoord*4) + currentPixel); // Look up the pixels input texture
                        colorOut += getPixelIncrementation(colorIn);
                    }
                }
            }
            else{
                for(int x=0; x<4; x++){
                    for(int y=0; y<4; y++){
                        vec2 currentPixel = vec2(x,y) / u_resolution;
                        vec4 colorIn = texture2D(u_textureIn, (v_texCoord*4) + currentPixel); // Look up the pixels input texture
                        colorOut += colorIn * 0.0625; // 0.0625 = 1/16 but multiply is faster than divide
                    }
                }
            }

            gl_FragColor = colorOut;
        }
        
        vec4 getPixelIncrementation(vec4 colorIn){
            vec4 toReturn = vec4(0,0,0,0);
            for(int i=0; i<4; i++){
                if(playerClrs[i] == colorIn.rgb){
                    toReturn[i] = colorIn.a * 0.0625; // 0.0625 = 1/16 but multiply is faster than divide
                }
            }
            return toReturn;
        }
    </script>

    <p>paint canvas</p>
    <canvas id="canvasPaint" width="128" height="128"></canvas>
    <p>input canvas</p>
    <canvas id="canvasInput" width="128" height="128"></canvas>
    <p>output canvas</p>
    <canvas id="canvasOutput" width="32" height="32"></canvas>
    
    <script src="/main.js"></script>
</body>
</html>